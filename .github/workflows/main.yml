name: ğŸ° Citadel Deployment Pipeline (GitHub Actions)

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering from the GitHub UI

permissions:
  id-token: write # Required for OIDC to assume the AWS IAM Role
  contents: read # Allows checking out the code

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: citadel-eks-cluster
  ECR_REPOSITORY: sentinel-app

jobs:
  # 1. ğŸ—ï¸ THE GREAT LAND GRANT (Provisioning with Terraform)
  provision_infrastructure:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Summon Code Scroll
        uses: actions/checkout@v4

      - name: ğŸ”‘ Assume IAM Role via OIDC (For Terraform)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::982534376726:role/GitHubActions-EKS-Deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ—ï¸ Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.0.0

      - name: ğŸ“œ Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: ğŸ”¨ Terraform Apply
        run: terraform apply -auto-approve
        working-directory: ./terraform

  # 2. âš”ï¸ THE MARCH OF DELIVERANCE (Build, Configure, and Deploy)
  deploy_application:
    needs: provision_infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Summon Code Scroll
        uses: actions/checkout@v4

      - name: ğŸ”‘ Assume IAM Role via OIDC (For Docker/Kubectl)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::982534376726:role/GitHubActions-EKS-Deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ³ Login to Docker Hub (or ECR)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ› ï¸ Build and Push Sentinel Vessel (Docker)
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}

      - name: ğŸ“œ Configure Kubectl
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: ğŸ“¦ Install Ansible & Dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install ansible kubernetes

      - name: ğŸŸ¢ Mark Build Stage GREEN
        run: |
          ansible-playbook -i ./ansible/inventory.ini ./ansible/main-playbook.yml --extra-vars "stage_name=build_and_push status=GREEN image_tag=${{ github.sha }}"

      - name: âš”ï¸ Deploy Garrison (Ansible Deployment to K8s)
        run: |
          ansible-playbook -i ./ansible/inventory.ini ./ansible/main-playbook.yml --extra-vars "stage_name=deploy_garrison status=RUNNING image_tag=${{ github.sha }}"

      - name: ğŸŸ¢ Mark Deploy Stage GREEN
        run: |
          ansible-playbook -i ./ansible/inventory.ini ./ansible/main-playbook.yml --extra-vars "stage_name=deploy_garrison status=GREEN image_tag=${{ github.sha }}"
