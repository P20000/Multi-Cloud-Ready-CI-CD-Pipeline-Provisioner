name: ğŸ° Citadel Deployment Pipeline (GitHub Actions)

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering from the GitHub UI

permissions:
  id-token: write # Required for OIDC to assume the AWS IAM Role
  contents: read # Allows checking out the code

env:
  # Define standard variables used across jobs
  AWS_REGION: us-east-1 # Change this if your EKS cluster is in a different region
  EKS_CLUSTER_NAME: citadel-eks-cluster # Must match the name defined in terraform/variables.tf
  ECR_REPOSITORY: p20000/sentinel-app
  
jobs:
  # 1. ğŸ—ï¸ THE GREAT LAND GRANT (Provisioning with Terraform)
  provision_infrastructure:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Summon Code Scroll
        uses: actions/checkout@v4

      - name: ğŸ”‘ Assume IAM Role via OIDC (For Terraform)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # !!! IMPORTANT: Replace this ARN with the ARN of the IAM Role you created in the previous step.
          role-to-assume: arn:aws:iam::982534376726:role/GitHubActions-EKS-Deployer 
          aws-region: ${{ env.AWS_REGION }}
          
      - name: ğŸ—ï¸ Setup Terraform CLI
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.0.0
          
      - name: ğŸ“œ Terraform Init (Initialize working directory)
        id: init
        run: terraform init
        working-directory: ./terraform
        
      - name: ğŸ”¨ Terraform Apply (Provision EKS Cluster)
        id: apply
        # This command provisions the VPC, EKS cluster, and Node Group.
        run: terraform apply -auto-approve
        working-directory: ./terraform

  # 2. âš”ï¸ THE MARCH OF DELIVERANCE (Build, Configure, and Deploy)
  deploy_application:
    needs: provision_infrastructure # Must wait for the cluster to be provisioned
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Summon Code Scroll
        uses: actions/checkout@v4
        
      - name: ğŸ”‘ Assume IAM Role via OIDC (For Docker/Kubectl)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::YOUR_ACCOUNT_ID:role/GitHubActions-EKS-Deployer
          aws-region: ${{ env.AWS_REGION }}
          
      - name: ğŸ³ Login to Docker Hub (or ECR)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ› ï¸ Build and Push Sentinel Vessel (Docker)
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: true
          # Tags the image with the latest commit SHA for unique versions
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}

      - name: ğŸ“œ Configure Kubectl (Connect to the K8s Stronghold)
        # Retrieves the Kubeconfig credentials using the assumed IAM Role
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
          
      - name: ğŸ“¦ Install Ansible & Dependencies
        run: |
          pip install ansible kubernetes # Install Ansible and the Python K8s library it needs

      - name: ğŸŸ¢ Sentinel Update: Mark Build Stage GREEN
        # This Ansible playbook/role updates the app/state_data.json
        run: |
          ansible-playbook -i localhost, ./ansible/main-deploy-playbook.yml --extra-vars 'stage_name=build_and_push status=GREEN image_tag=${{ github.sha }}'

      - name: âš”ï¸ Deploy Garrison (Ansible Deployment to K8s)
        # This playbook uses the K8s module to apply the deployment manifest
        run: |
          ansible-playbook -i localhost, ./ansible/main-deploy-playbook.yml --extra-vars 'stage_name=deploy_garrison status=RUNNING image_tag=${{ github.sha }}'
          
      - name: ğŸŸ¢ Sentinel Update: Mark Deploy Stage GREEN
        # Final update to signal success to the Sentinel App
        run: |
          ansible-playbook -i localhost, ./ansible/main-deploy-playbook.yml --extra-vars 'stage_name=deploy_garrison status=GREEN image_tag=${{ github.sha }}'